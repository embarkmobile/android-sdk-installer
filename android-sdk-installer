#!/usr/bin/env bash

# Copyright (c) 2013 Embark Mobile
# Licensed under the MIT License.
# https://github.com/embarkmobile/android-sdk-installer

set +e

#detecting os
os=linux
if [[ `uname` == 'Darwin' ]]; then
    os=osx
fi

# Constants
ANDROID_SDK_VERSION=24.4.1
if [[ $os == 'linux' ]]; then
    SDK_FILE=android-sdk_r$ANDROID_SDK_VERSION-linux.tgz
elif [[ $os == 'osx' ]]; then
    SDK_FILE=android-sdk_r$ANDROID_SDK_VERSION-macosx.zip
fi
SDK_URL=http://dl.google.com/android/$SDK_FILE

# Defaults
INSTALLER_DIR=$HOME/.android-sdk-installer
INSTALL_ALL="-a"

for i in "$@"
do
case $i in
    --dir=*)
    INSTALLER_DIR=`echo $i | sed 's/[-a-zA-Z0-9]*=//'`
    ;;
    --skipAll)
    INSTALL_ALL=""
    ;;
    *)
    # unknown option
    ;;
esac
done

# Expand the path
if [[ $os == 'linux' ]]; then
    INSTALLER_DIR=`readlink -f "$INSTALLER_DIR"`
elif [[ $os == 'osx' ]]; then
    INSTALLER_DIR=`stat -f "$INSTALLER_DIR"`
fi

TOOLS_DIR=$INSTALLER_DIR/tools

echo "Installing SDK in $INSTALLER_DIR"

mkdir -p $INSTALLER_DIR
mkdir -p $TOOLS_DIR

echo "Downloading SDK"
wget -nv -c -O $INSTALLER_DIR/$SDK_FILE $SDK_URL
echo "Extracting SDK"

if [[ $os == 'linux' ]]; then
    tar xzf $INSTALLER_DIR/$SDK_FILE --directory $INSTALLER_DIR
    export ANDROID_HOME=$INSTALLER_DIR/android-sdk-linux
elif [[ $os == 'osx' ]]; then
    unzip -q -o -d $INSTALLER_DIR $INSTALLER_DIR/$SDK_FILE
    export ANDROID_HOME=$INSTALLER_DIR/android-sdk-macosx
fi

# Setup environment file
echo "export ANDROID_HOME=$ANDROID_HOME" > $INSTALLER_DIR/env
echo "export PATH=$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools:$TOOLS_DIR:\$PATH" >> $INSTALLER_DIR/env

android () {
  "$ANDROID_HOME/tools/android" "$@"
}

needed_packages () {
  android list sdk -u -s $@ |\
    # Filter obsoleted packages
    grep '\s\+\d\+-'      |\
    sed '/\(Source\)/d' |\
    sed '/\(Documentation\)/d' |\
    sed '/\(MIPS\)/d' |\
    sed '/\(Android Wear\)/d' |\
    sed '/\(Android TV\)/d' |\
    # Filter to take only the index number of package
    sed 's/^[ ]*\([0-9]*\)-.*/\1/' |\
    paste -d, -s -
}

main () {
  echo $(needed_packages $INSTALL_ALL)
  (while : ; do
  echo 'y'
  sleep 1
  done) | android update sdk -u -s -a -t "$(needed_packages $INSTALL_ALL)"
}

main

#create symlink
ln -s $INSTALLER_DIR/android-sdk-macosx $HOME/.android-sdk